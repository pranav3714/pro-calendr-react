---
phase: 03-event-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/types/interaction.ts
  - packages/core/src/store/slices/interaction-slice.ts
  - packages/core/src/utils/snap.ts
  - packages/core/src/components/CalendarProvider.tsx
  - packages/core/src/components/CalendarContext.tsx
  - packages/core/src/components/CalendarBody.tsx
  - packages/core/src/styles/calendar.css
autonomous: true

must_haves:
  truths:
    - "Interaction slice tracks drag phase (idle/pending/dragging), drag mode (move/resize-start/resize-end/select), snapped times, and validity"
    - "pointerToSnappedTime converts clientY + container geometry to a snapped Date on a reference day"
    - "CalendarConfig exposes onEventDrop, onEventResize, onSelect, and validateDrop callbacks to all nested components"
    - "CSS classes exist for drag ghost, selection overlay, drop indicator, resize handles, drag tooltip, and drag state on events and calendar root"
  artifacts:
    - path: "packages/core/src/types/interaction.ts"
      provides: "DragPhase, DragMode, DragEngineState types"
      contains: "DragPhase"
    - path: "packages/core/src/store/slices/interaction-slice.ts"
      provides: "Enhanced InteractionSlice with drag phase machine actions"
      contains: "setDragPhase"
    - path: "packages/core/src/utils/snap.ts"
      provides: "pointerToSnappedTime coordinate conversion"
      exports: ["pointerToSnappedTime", "snapToGrid"]
    - path: "packages/core/src/components/CalendarProvider.tsx"
      provides: "CalendarConfig with interaction callbacks"
      contains: "onEventDrop"
    - path: "packages/core/src/styles/calendar.css"
      provides: "Interaction CSS classes"
      contains: "pro-calendr-react-drag-ghost"
  key_links:
    - from: "packages/core/src/store/slices/interaction-slice.ts"
      to: "packages/core/src/types/interaction.ts"
      via: "DragEngineState import"
      pattern: "import.*DragEngineState.*interaction"
    - from: "packages/core/src/components/CalendarProvider.tsx"
      to: "packages/core/src/types/event.ts"
      via: "EventDropInfo, EventResizeInfo imports for callback types"
      pattern: "import.*EventDropInfo"
---

<objective>
Build the foundation layer for all event interactions: enhanced types, drag state machine in the Zustand interaction slice, coordinate-to-time conversion utility, CalendarProvider callback wiring, and all CSS styles for drag/resize/select feedback.

**Scope Note:** This phase implements time-based drag/resize/select interactions for WeekView and DayView. Resource-based interactions (INTR-02: drag across resources, INTR-07: resource label during drag) are explicitly deferred to Phase 6 when TimelineView and Resources exist.

Purpose: Every subsequent plan (drag engine hook, visual components, integration) depends on these types, store actions, utilities, and styles being in place.
Output: Enhanced interaction types, richer interaction slice, pointerToSnappedTime utility, CalendarConfig with all interaction callbacks, complete CSS for drag/resize/select.
</objective>

<execution_context>
@/home/blacksilver/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/blacksilver/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-event-interactions/03-RESEARCH.md
@packages/core/src/types/interaction.ts
@packages/core/src/types/event.ts
@packages/core/src/types/calendar.ts
@packages/core/src/types/theme.ts
@packages/core/src/store/slices/interaction-slice.ts
@packages/core/src/store/calendar-store.ts
@packages/core/src/utils/snap.ts
@packages/core/src/utils/slot.ts
@packages/core/src/utils/date-utils.ts
@packages/core/src/components/CalendarProvider.tsx
@packages/core/src/components/CalendarContext.tsx
@packages/core/src/components/CalendarBody.tsx
@packages/core/src/styles/calendar.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance interaction types and interaction slice with drag state machine</name>
  <files>
    packages/core/src/types/interaction.ts
    packages/core/src/store/slices/interaction-slice.ts
  </files>
  <action>
**interaction.ts** -- Add these types alongside existing ones (do NOT remove existing Selection, SelectInfo, DragOrigin, DragPosition, DragState, etc.):

```typescript
export type DragPhase = 'idle' | 'pending' | 'dragging';
export type DragMode = 'move' | 'resize-start' | 'resize-end' | 'select';

export interface DragEngineState {
  phase: DragPhase;
  mode: DragMode | null;
  origin: DragOrigin | null;
  current: DragPosition | null;
  initialPointer: { x: number; y: number } | null;
  isValid: boolean;
  validationMessage?: string;
  snappedStart: Date | null;
  snappedEnd: Date | null;
}
```

Also add a `ResizeEdge` type alias: `export type ResizeEdge = 'start' | 'end';`

**interaction-slice.ts** -- Replace the simple `dragState: DragState | null` with the richer `DragEngineState`. Keep `selection` and `hoveredSlot` unchanged. Add these actions:

- `startPending(mode: DragMode, origin: DragOrigin, initialPointer: { x: number; y: number })` -- sets phase='pending', mode, origin, initialPointer, clears snappedStart/End, isValid=true
- `startDragging()` -- transitions phase from 'pending' to 'dragging' (no-op if not pending)
- `updateDragPosition(current: DragPosition, snappedStart: Date, snappedEnd: Date, isValid: boolean, validationMessage?: string)` -- updates current, snapped times, validity. Only applies when phase='dragging'.
- `completeDrag()` -- resets all drag state to idle defaults
- `cancelDrag()` -- same as completeDrag (resets to idle)

The idle defaults: `{ phase: 'idle', mode: null, origin: null, current: null, initialPointer: null, isValid: true, snappedStart: null, snappedEnd: null }`

Remove the old `setDragState` action. Keep `setSelection` and `setHoveredSlot`. Rename the state field from `dragState` to `dragEngine` for clarity.

Update the CalendarStore type reference in calendar-store.ts if needed (grep for `dragState` usage and update to `dragEngine`).

Also update `use-drag.ts` to expose the new drag engine state:
```typescript
export function useDrag() {
  const dragEngine = useCalendarStore((s) => s.dragEngine);
  const startPending = useCalendarStore((s) => s.startPending);
  const startDragging = useCalendarStore((s) => s.startDragging);
  const updateDragPosition = useCalendarStore((s) => s.updateDragPosition);
  const completeDrag = useCalendarStore((s) => s.completeDrag);
  const cancelDrag = useCalendarStore((s) => s.cancelDrag);
  return { dragEngine, startPending, startDragging, updateDragPosition, completeDrag, cancelDrag };
}
```
  </action>
  <verify>
Run `pnpm typecheck` -- no type errors. Run `pnpm lint` -- no lint errors. Grep for `dragState` across codebase to ensure all references updated to `dragEngine`.
  </verify>
  <done>
DragPhase, DragMode, DragEngineState, ResizeEdge types exported from interaction.ts. InteractionSlice has dragEngine field with startPending/startDragging/updateDragPosition/completeDrag/cancelDrag actions. useDrag hook exposes new API. No type or lint errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pointerToSnappedTime utility and DRAG_THRESHOLD constant</name>
  <files>
    packages/core/src/utils/snap.ts
    packages/core/src/constants/index.ts
  </files>
  <action>
**snap.ts** -- Add `pointerToSnappedTime` function alongside existing `snapToGrid`. This function converts browser pointer coordinates to a snapped Date:

```typescript
import { getSlotAtPosition } from './slot';
import { parseTimeToMinutes, minutesToDate } from './date-utils';

/**
 * Convert a pointer clientY position to a snapped time on a reference day.
 *
 * Pipeline: clientY -> containerRelativeY -> slotIndex -> minutes -> snappedDate
 */
export function pointerToSnappedTime(
  clientY: number,
  containerRect: DOMRect,
  scrollTop: number,
  slotHeight: number,
  slotDuration: number,
  slotMinTime: string,
  totalSlots: number,
  referenceDay: Date,
): Date {
  const relativeY = clientY - containerRect.top + scrollTop;
  const slotIndex = getSlotAtPosition(relativeY, slotHeight, totalSlots);
  const gridStartMinutes = parseTimeToMinutes(slotMinTime);
  const minutes = gridStartMinutes + slotIndex * slotDuration;
  return minutesToDate(minutes, referenceDay);
}
```

Also add a `pointerToColumnIndex` function for determining which day column the pointer is over:

```typescript
/**
 * Convert a pointer clientX position to a column index (day index).
 */
export function pointerToColumnIndex(
  clientX: number,
  containerRect: DOMRect,
  columnCount: number,
  timeLabelsWidth: number,
): number {
  const relativeX = clientX - containerRect.left - timeLabelsWidth;
  const columnWidth = (containerRect.width - timeLabelsWidth) / columnCount;
  const index = Math.floor(relativeX / columnWidth);
  return Math.max(0, Math.min(index, columnCount - 1));
}
```

Also add `exceedsThreshold` utility:

```typescript
/**
 * Check if pointer movement exceeds the drag threshold (distinguishes click from drag).
 */
export function exceedsThreshold(
  current: { x: number; y: number },
  initial: { x: number; y: number },
  threshold: number,
): boolean {
  const dx = current.x - initial.x;
  const dy = current.y - initial.y;
  return Math.sqrt(dx * dx + dy * dy) >= threshold;
}
```

**constants/index.ts** -- Add `DRAG_THRESHOLD: 4` to the DEFAULTS object (or export as separate constant if DEFAULTS is already structured differently). Check the existing constants file first and follow its pattern.
  </action>
  <verify>
Run `pnpm typecheck` -- no errors. Run `pnpm lint` -- no errors. The functions should be importable: `import { pointerToSnappedTime, pointerToColumnIndex, exceedsThreshold } from '../utils/snap'`.
  </verify>
  <done>
pointerToSnappedTime, pointerToColumnIndex, and exceedsThreshold exported from snap.ts. DRAG_THRESHOLD constant available. All utilities are pure functions with no side effects.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire interaction callbacks into CalendarProvider and add interaction CSS</name>
  <files>
    packages/core/src/components/CalendarProvider.tsx
    packages/core/src/components/CalendarBody.tsx
    packages/core/src/styles/calendar.css
  </files>
  <action>
**CalendarProvider.tsx** -- Add these fields to both `CalendarConfig` interface and `CalendarProviderProps` interface:

```typescript
onEventDrop?: (info: EventDropInfo) => void;
onEventResize?: (info: EventResizeInfo) => void;
onSelect?: (info: SelectInfo) => void;
validateDrop?: (info: { event: CalendarEvent; newStart: Date; newEnd: Date; newResourceId?: string }) => DropValidationResult;
```

Import `EventDropInfo`, `EventResizeInfo` from `../types/event` and `SelectInfo`, `DropValidationResult` from `../types/interaction`. Also import `CalendarEvent` from `../types`.

Add these as props in the CalendarProvider function signature with defaults (undefined), and include them in the useMemo config object and its dependency array.

**CalendarBody.tsx** -- Pass the new callbacks from config down to viewProps:

```typescript
const viewProps = {
  // ... existing props
  editable: config.editable,
  selectable: config.selectable,
  onEventDrop: config.onEventDrop,
  onEventResize: config.onEventResize,
  onSelect: config.onSelect,
  validateDrop: config.validateDrop,
};
```

Do NOT yet change the view component prop types (WeekView, DayView etc.) -- that happens in Plan 03 when we wire the interactions. Just pass them so they're available.

**calendar.css** -- Add all interaction CSS styles at the end of the file, before the print/reduced-motion media queries. Follow the research recommendations exactly:

```css
/* === Event Interactions === */

/* Drag ghost element following cursor */
.pro-calendr-react-drag-ghost {
  position: fixed;
  pointer-events: none;
  z-index: 1000;
  opacity: 0.85;
  box-shadow: var(--cal-shadow-lg);
  border-radius: var(--cal-radius-sm);
  overflow: hidden;
}

/* Original event during drag */
.pro-calendr-react-event[data-dragging] {
  opacity: 0.3;
}

/* Selection overlay */
.pro-calendr-react-selection-overlay {
  position: absolute;
  background-color: var(--cal-selection);
  border: 1px solid var(--cal-accent);
  border-radius: var(--cal-radius-sm);
  pointer-events: none;
  z-index: 8;
}

/* Drop validity indicators */
.pro-calendr-react-drop-indicator {
  position: absolute;
  pointer-events: none;
  z-index: 15;
  border-radius: var(--cal-radius-sm);
}

.pro-calendr-react-drop-indicator--valid {
  outline: 2px solid #22c55e;
  outline-offset: -2px;
}

.pro-calendr-react-drop-indicator--invalid {
  outline: 2px solid #ef4444;
  outline-offset: -2px;
}

/* Resize handles */
.pro-calendr-react-event-resize-handle {
  position: absolute;
  left: 0;
  right: 0;
  height: 6px;
  cursor: ns-resize;
  z-index: 6;
  opacity: 0;
  transition: opacity 0.15s;
}

.pro-calendr-react-event:hover .pro-calendr-react-event-resize-handle {
  opacity: 1;
}

.pro-calendr-react-event-resize-handle--top {
  top: 0;
  border-radius: var(--cal-radius-sm) var(--cal-radius-sm) 0 0;
}

.pro-calendr-react-event-resize-handle--bottom {
  bottom: 0;
  border-radius: 0 0 var(--cal-radius-sm) var(--cal-radius-sm);
}

.pro-calendr-react-event-resize-handle:hover {
  background-color: rgb(255 255 255 / 0.3);
}

/* Prevent text selection during drag */
.pro-calendr-react[data-dragging] {
  user-select: none;
  -webkit-user-select: none;
}

/* Time tooltip during drag */
.pro-calendr-react-drag-tooltip {
  position: fixed;
  pointer-events: none;
  z-index: 1001;
  background: var(--cal-bg);
  color: var(--cal-text);
  border: 1px solid var(--cal-border);
  border-radius: var(--cal-radius-sm);
  padding: 4px 8px;
  font-size: var(--cal-font-size-sm);
  box-shadow: var(--cal-shadow);
  white-space: nowrap;
}

/* Drag tooltip validity colors */
.pro-calendr-react-drag-tooltip--valid {
  border-color: #22c55e;
}

.pro-calendr-react-drag-tooltip--invalid {
  border-color: #ef4444;
  color: #ef4444;
}

/* Drag layer portal overlay */
.pro-calendr-react-drag-layer {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999;
}
```

Make sure the dark mode variant sections also include interaction-related variable overrides if needed (the current variables like --cal-selection, --cal-bg, --cal-border are already used, so no new dark mode variables are needed).
  </action>
  <verify>
Run `pnpm typecheck` -- no errors. Run `pnpm lint` -- no errors. Run `pnpm build` -- CSS builds successfully. Verify CalendarConfig now has onEventDrop, onEventResize, onSelect, validateDrop fields.
  </verify>
  <done>
CalendarConfig and CalendarProviderProps include onEventDrop, onEventResize, onSelect, and validateDrop. CalendarBody passes these to viewProps. All interaction CSS classes exist (drag ghost, selection overlay, drop indicator, resize handles, tooltip, drag layer, drag state data attributes).
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes with zero errors
2. `pnpm lint` passes with zero errors
3. `pnpm build` succeeds (CSS compiles, TypeScript compiles)
4. `pnpm test` -- existing tests still pass (no regressions from dragState -> dragEngine rename)
5. Grep for `DragPhase` in types/interaction.ts returns a match
6. Grep for `startPending` in store/slices/interaction-slice.ts returns a match
7. Grep for `pointerToSnappedTime` in utils/snap.ts returns a match
8. Grep for `onEventDrop` in CalendarProvider.tsx returns a match
9. Grep for `pro-calendr-react-drag-ghost` in calendar.css returns a match
</verification>

<success_criteria>
- DragPhase/DragMode/DragEngineState/ResizeEdge types exported from interaction.ts
- InteractionSlice has dragEngine with 5 action methods (startPending, startDragging, updateDragPosition, completeDrag, cancelDrag)
- pointerToSnappedTime, pointerToColumnIndex, exceedsThreshold exported from snap.ts
- DRAG_THRESHOLD constant available
- CalendarConfig includes onEventDrop, onEventResize, onSelect, validateDrop
- Complete interaction CSS in calendar.css
- Zero type errors, zero lint errors, zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-event-interactions/03-01-SUMMARY.md`
</output>
