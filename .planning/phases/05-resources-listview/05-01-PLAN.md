---
phase: 05-resources-listview
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/store/slices/resource-slice.ts
  - packages/core/src/utils/resource-utils.ts
  - packages/core/src/utils/__tests__/resource-utils.test.ts
  - packages/core/src/hooks/use-resources.ts
  - packages/core/src/hooks/index.ts
  - packages/core/src/components/CalendarProvider.tsx
  - packages/core/src/types/theme.ts
autonomous: true

must_haves:
  truths:
    - "Consumer can pass resources and resourceGroups arrays through CalendarProvider and access them via useCalendarConfig()"
    - "Resources are organized into a tree structure with two-level grouping (group > resource) via groupId"
    - "Filtering by resource IDs returns only matching resources in the tree"
    - "Resource groups can be collapsed/expanded via store actions and collapse state is reflected in the tree"
    - "Resource render slot functions (resourceLabel, resourceGroupHeader) are available in CalendarConfig"
  artifacts:
    - path: "packages/core/src/store/slices/resource-slice.ts"
      provides: "Collapse state and toggle action for resource groups"
      contains: "collapsedGroupIds"
    - path: "packages/core/src/utils/resource-utils.ts"
      provides: "Pure function for building grouped/filtered/sorted resource tree"
      exports: ["buildResourceTree", "ResourceGroupNode", "ResourceTree"]
    - path: "packages/core/src/utils/__tests__/resource-utils.test.ts"
      provides: "Tests for buildResourceTree covering grouping, filtering, collapsing, ordering"
      min_lines: 60
    - path: "packages/core/src/hooks/use-resources.ts"
      provides: "Hook computing resource tree from CalendarConfig + store state"
      exports: ["useResources"]
    - path: "packages/core/src/components/CalendarProvider.tsx"
      provides: "CalendarConfig extended with resource props"
      contains: "resources"
  key_links:
    - from: "packages/core/src/hooks/use-resources.ts"
      to: "packages/core/src/utils/resource-utils.ts"
      via: "buildResourceTree call"
      pattern: "buildResourceTree\\("
    - from: "packages/core/src/hooks/use-resources.ts"
      to: "packages/core/src/components/CalendarContext.tsx"
      via: "useCalendarConfig and useCalendarStore selectors"
      pattern: "useCalendarConfig|useCalendarStore"
    - from: "packages/core/src/components/CalendarProvider.tsx"
      to: "packages/core/src/types/resource.ts"
      via: "CalendarConfig interface uses resource types"
      pattern: "CalendarResource|ResourceLabelProps|ResourceGroupHeaderProps"
---

<objective>
Build the resource data layer: extend the Zustand ResourceSlice with collapse state, create a pure buildResourceTree utility for grouping/filtering/sorting resources, create the useResources computation hook, and wire all resource-related props (resources, resourceGroups, resourceLabel, resourceGroupHeader, resourceAreaWidth, filterResourcesWithEvents) through CalendarConfig.

Purpose: This is the foundation for all resource-aware features (RSRC-01 through RSRC-06). Phase 6 TimelineView will consume useResources to render resource rows and sidebar.
Output: Extended resource-slice.ts, resource-utils.ts with tests, use-resources.ts hook, CalendarProvider with resource config fields.
</objective>

<execution_context>
@/home/blacksilver/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/blacksilver/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-resources-listview/05-RESEARCH.md
@packages/core/src/store/slices/resource-slice.ts
@packages/core/src/store/calendar-store.ts
@packages/core/src/types/resource.ts
@packages/core/src/types/theme.ts
@packages/core/src/hooks/use-calendar.ts
@packages/core/src/hooks/index.ts
@packages/core/src/components/CalendarProvider.tsx
@packages/core/src/components/CalendarContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ResourceSlice and create buildResourceTree utility with tests</name>
  <files>
    packages/core/src/store/slices/resource-slice.ts
    packages/core/src/utils/resource-utils.ts
    packages/core/src/utils/__tests__/resource-utils.test.ts
  </files>
  <action>
**resource-slice.ts:** Extend the existing ResourceSlice interface and createResourceSlice implementation:
- Add `collapsedGroupIds: string[]` field (use string[] not Set per research pitfall 3 -- Zustand Object.is equality)
- Add `toggleGroupCollapse: (groupId: string) => void` action that toggles membership: if present, filter out; if absent, spread+append. Use `get()` to read current state.
- Add `setCollapsedGroupIds: (ids: string[]) => void` action for bulk set
- Keep existing `filteredResourceIds` and `setFilteredResourceIds` unchanged
- Follow the existing StateCreator<CalendarStore, [], [], ResourceSlice> pattern exactly

**resource-utils.ts:** Create a new pure utility file with:
- Export `ResourceGroupNode` interface: `{ group: CalendarResourceGroup; resources: CalendarResource[]; isCollapsed: boolean }`
- Export `ResourceTree` interface: `{ groups: ResourceGroupNode[]; ungrouped: CalendarResource[] }`
- Export `buildResourceTree(resources, groups, filteredIds, collapsedGroupIds): ResourceTree` function:
  1. If `filteredIds` is non-empty, filter resources to only those whose id is in filteredIds
  2. Partition resources into grouped (has groupId matching a group) and ungrouped
  3. For each group that has matching resources, create a ResourceGroupNode with sorted resources (by `order ?? 0`)
  4. Sort ungrouped resources by `order ?? 0`
  5. Sort group nodes by group `order ?? 0`
  6. Set `isCollapsed` by checking if group.id exists in collapsedGroupIds array
  7. Return `{ groups: groupNodes, ungrouped }`
- Use Set for O(1) lookups internally (collapsedGroupIds, filteredIds) but accept arrays as params
- Import types from `../types` (CalendarResource, CalendarResourceGroup)

**resource-utils.test.ts:** Create comprehensive tests:
- Test: returns empty tree for empty inputs
- Test: ungrouped resources sorted by order
- Test: resources grouped by groupId with correct group assignment
- Test: groups sorted by group order
- Test: resources within groups sorted by resource order
- Test: filteredIds filters to only matching resources
- Test: empty filteredIds means no filtering (show all)
- Test: collapsedGroupIds sets isCollapsed=true on matching groups
- Test: resources with groupId not matching any group go to ungrouped
- Use `describe("buildResourceTree", () => { ... })` structure
  </action>
  <verify>
Run `pnpm vitest run packages/core/src/utils/__tests__/resource-utils.test.ts` -- all tests pass.
Run `pnpm typecheck` -- no type errors.
  </verify>
  <done>ResourceSlice has collapsedGroupIds + toggleGroupCollapse + setCollapsedGroupIds. buildResourceTree produces correct grouped/filtered/sorted tree structure. All 9+ test cases pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create useResources hook, wire CalendarConfig with resource props, add classNames slots</name>
  <files>
    packages/core/src/hooks/use-resources.ts
    packages/core/src/hooks/index.ts
    packages/core/src/components/CalendarProvider.tsx
    packages/core/src/types/theme.ts
  </files>
  <action>
**use-resources.ts:** Create the computation hook following the useCalendar() convenience hook pattern:
- Import `useCalendarConfig` and `useCalendarStore` from `../components/CalendarContext`
- Import `buildResourceTree` and `ResourceTree` from `../utils/resource-utils`
- Import `useMemo` from React
- Export `function useResources(): ResourceTree` that:
  1. Reads `config` via `useCalendarConfig()`
  2. Reads `filteredResourceIds` via `useCalendarStore(s => s.filteredResourceIds)`
  3. Reads `collapsedGroupIds` via `useCalendarStore(s => s.collapsedGroupIds)`
  4. Returns `useMemo(() => buildResourceTree(config.resources ?? [], config.resourceGroups ?? [], filteredResourceIds, collapsedGroupIds), [config.resources, config.resourceGroups, filteredResourceIds, collapsedGroupIds])`
- Also re-export `ResourceTree` and `ResourceGroupNode` types from resource-utils for consumer convenience

**hooks/index.ts:** Add `export { useResources } from "./use-resources";` to the barrel file.

**CalendarProvider.tsx:** Extend CalendarConfig interface and CalendarProviderProps to include resource fields:
- Add to CalendarConfig interface:
  - `resources?: CalendarResource[]`
  - `resourceGroups?: CalendarResourceGroup[]`
  - `resourceLabel?: (props: ResourceLabelProps) => ReactNode`
  - `resourceGroupHeader?: (props: ResourceGroupHeaderProps) => ReactNode`
  - `resourceAreaWidth?: number | string`
  - `filterResourcesWithEvents?: boolean`
- Add same fields to CalendarProviderProps interface (all optional)
- Add to CalendarProvider function parameters (all with no default -- they're optional):
  - `resources`, `resourceGroups`, `resourceLabel`, `resourceGroupHeader`, `resourceAreaWidth`, `filterResourcesWithEvents`
- Add all six fields to the `config` useMemo object AND its dependency array
- Import types: `CalendarResource`, `CalendarResourceGroup`, `ResourceLabelProps`, `ResourceGroupHeaderProps` from `../types`

**types/theme.ts:** Add ListView and resource-related classNames slots to CalendarClassNames interface:
- Add `listView?: string` -- root list view container
- Add `listDateHeader?: string` -- date group header in list view
- Add `listEventRow?: string` -- individual event row in list view
- Add `listEmptyMessage?: string` -- empty state message
- Keep all existing slots unchanged
  </action>
  <verify>
Run `pnpm typecheck` -- no type errors (confirms CalendarConfig, CalendarProviderProps, CalendarClassNames all valid).
Run `pnpm lint` -- no lint errors.
  </verify>
  <done>useResources hook exists and computes ResourceTree from config + store. CalendarConfig includes all six resource fields. CalendarClassNames has listView/listDateHeader/listEventRow/listEmptyMessage slots. useResources is exported from hooks/index.ts.</done>
</task>

</tasks>

<verification>
- `pnpm vitest run packages/core/src/utils/__tests__/resource-utils.test.ts` passes all tests
- `pnpm typecheck` succeeds with no errors
- `pnpm lint` succeeds with no errors
- `pnpm build` succeeds (no import issues)
</verification>

<success_criteria>
1. ResourceSlice extended with collapsedGroupIds, toggleGroupCollapse, setCollapsedGroupIds
2. buildResourceTree produces correct tree with grouping, filtering, collapse state, and ordering
3. All resource-utils tests pass
4. useResources hook computes tree from CalendarConfig + store state via useMemo
5. CalendarConfig and CalendarProviderProps include all 6 resource fields
6. CalendarClassNames has 4 new list view slots
7. typecheck, lint, and build all pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-resources-listview/05-01-SUMMARY.md`
</output>
