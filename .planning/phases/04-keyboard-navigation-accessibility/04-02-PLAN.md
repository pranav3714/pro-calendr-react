---
phase: 04-keyboard-navigation-accessibility
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/core/src/views/week/WeekView.tsx
  - packages/core/src/views/week/TimeSlotColumn.tsx
  - packages/core/src/views/day/DayView.tsx
  - packages/core/src/views/month/MonthView.tsx
  - packages/core/src/views/month/WeekRow.tsx
  - packages/core/src/views/month/DayCell.tsx
  - packages/core/src/components/EventBlock.tsx
autonomous: true

must_haves:
  truths:
    - "WeekView and DayView time grids have role='grid' with aria-rowcount and aria-colcount"
    - "Each time slot div has role='gridcell', aria-rowindex, aria-colindex, and managed tabIndex from useRovingGrid"
    - "MonthView has role='grid', WeekRow has role='row', DayCell has role='gridcell' with managed tabIndex"
    - "EventBlock tabIndex={0} is replaced with managed tabIndex={-1} (grid cells own tab stops, not events)"
    - "MonthEventChip tabIndex={0} is replaced with tabIndex={-1}"
    - "Arrow keys navigate between time slots in WeekView/DayView and between day cells in MonthView"
    - "Each time slot has an aria-label describing the time and day"
  artifacts:
    - path: "packages/core/src/views/week/WeekView.tsx"
      provides: "ARIA grid container with useRovingGrid integration"
      contains: "role=\"grid\""
    - path: "packages/core/src/views/week/TimeSlotColumn.tsx"
      provides: "Grid cells with ARIA attributes and managed tabIndex"
      contains: "role=\"gridcell\""
    - path: "packages/core/src/views/month/MonthView.tsx"
      provides: "ARIA grid container for month view"
      contains: "role=\"grid\""
    - path: "packages/core/src/components/EventBlock.tsx"
      provides: "Managed tabIndex replacing hardcoded tabIndex={0}"
      contains: "tabIndex={-1}"
  key_links:
    - from: "packages/core/src/views/week/WeekView.tsx"
      to: "packages/core/src/hooks/use-roving-grid.ts"
      via: "useRovingGrid hook providing getCellProps"
      pattern: "useRovingGrid"
    - from: "packages/core/src/views/week/TimeSlotColumn.tsx"
      to: "packages/core/src/hooks/use-roving-grid.ts"
      via: "getCellProps applied to each time slot div"
      pattern: "getCellProps"
    - from: "packages/core/src/views/month/MonthView.tsx"
      to: "packages/core/src/hooks/use-roving-grid.ts"
      via: "useRovingGrid for month grid navigation"
      pattern: "useRovingGrid"
---

<objective>
Add ARIA grid semantics to all views and wire the useRovingGrid hook for keyboard navigation within each view's grid cells.

Purpose: This makes the calendar navigable with arrow keys and screen-reader accessible. Time-grid views (Week, Day) get role="grid" with gridcell slots carrying aria-rowindex/aria-colindex. MonthView gets native row-based ARIA grid. EventBlock and MonthEventChip lose their independent tabIndex={0} to comply with the roving tabindex pattern.

Output: All three view types have working ARIA grid semantics and keyboard grid navigation.
</objective>

<execution_context>
@/home/blacksilver/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/blacksilver/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-keyboard-navigation-accessibility/04-RESEARCH.md
@.planning/phases/04-keyboard-navigation-accessibility/04-01-SUMMARY.md
@packages/core/src/views/week/WeekView.tsx
@packages/core/src/views/week/TimeSlotColumn.tsx
@packages/core/src/views/day/DayView.tsx
@packages/core/src/views/month/MonthView.tsx
@packages/core/src/views/month/WeekRow.tsx
@packages/core/src/views/month/DayCell.tsx
@packages/core/src/components/EventBlock.tsx
@packages/core/src/hooks/use-roving-grid.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ARIA grid attributes and useRovingGrid wiring for time-grid views (Week + Day)</name>
  <files>
    packages/core/src/views/week/WeekView.tsx
    packages/core/src/views/week/TimeSlotColumn.tsx
    packages/core/src/views/day/DayView.tsx
  </files>
  <action>
**1. WeekView.tsx:**
- Import `useRovingGrid` and `GridPosition` from `../../hooks/use-roving-grid`
- Import `useCalendarStore` for `setFocusedDate` access
- Add a `useRef<HTMLDivElement>(null)` for the grid container (the `.pro-calendr-react-week-grid` div)
- Call `useRovingGrid({ rows: slots.length, cols: days.length, gridRef, onCellFocus, onCellActivate })`:
  - `onCellFocus`: Convert position to Date using `days[col]` and `slots[row].time`, then call `setFocusedDate(date)` on the store
  - `onCellActivate`: For now, no-op (Enter/Space activation handled in Plan 03)
  - Compute `initialPosition` from store's `focusedDate` by finding the matching day column and time slot row, defaulting to `{row: 0, col: 0}` if no match
- Add to the `.pro-calendr-react-week-grid` div: `ref={gridRef}`, `role="grid"`, `aria-label="Week view calendar grid"`, `aria-rowcount={slots.length}`, `aria-colcount={days.length}`
- Pass `getCellProps` down to TimeSlotColumn as a new prop

**2. TimeSlotColumn.tsx:**
- Accept new prop: `getCellProps: (row: number, col: number) => object` and `dayIndex: number` (the column index of this day)
- On each time slot `<div>` (the `.pro-calendr-react-time-slot` elements), spread `getCellProps(slotIndex, dayIndex)` which provides tabIndex, onKeyDown, onFocus, data-grid-row, data-grid-col
- Add `role="gridcell"` to each slot div
- Add `aria-rowindex={slotIndex + 1}` and `aria-colindex={dayIndex + 1}` (1-based per ARIA spec)
- Add `aria-label` describing the time and day: e.g., `"9:00 AM, Monday, February 16"` using the slot's time and the `day` prop. Use `format(day, 'EEEE, MMMM d')` from date-fns for the day part, and the slot's existing `label` for the time part.
- The `getCellProps` and `dayIndex` props must be added to `TimeSlotColumnProps` interface
- WeekView passes `dayIndex={index}` where `index` comes from `days.map((day, index) => ...)`

**3. DayView.tsx:**
- Same pattern as WeekView but with `cols: 1` (single day)
- Import and call `useRovingGrid({ rows: slots.length, cols: 1, gridRef, ... })`
- Add `role="grid"`, `aria-label="Day view calendar grid"`, `aria-rowcount`, `aria-colcount` to the `.pro-calendr-react-day-grid` div
- Pass `getCellProps` and `dayIndex={0}` to the single TimeSlotColumn

**Important architectural note:** The time grid DOM is column-major (each day is a column div containing slot divs). ARIA grid is row-major. We use `aria-rowindex`/`aria-colindex` to declare logical position. The useRovingGrid hook handles focus movement correctly by querying `data-grid-row`/`data-grid-col` attributes regardless of DOM order. This is the approach recommended in the RESEARCH.md and used by production calendars.

**Props threading:** WeekView and DayView already pass many props to TimeSlotColumn. Add `getCellProps` and `dayIndex` as two more. getCellProps type is the return type of `useRovingGrid().getCellProps` -- import or inline the type.
  </action>
  <verify>
    Run `pnpm typecheck` -- no type errors.
    Run `pnpm lint` -- no lint violations.
    Verify WeekView has `role="grid"` on the grid container.
    Verify TimeSlotColumn slot divs have `role="gridcell"`, `aria-rowindex`, `aria-colindex`.
    Run `pnpm test:ci` -- existing tests pass (may need minor updates if tests assert exact DOM structure).
  </verify>
  <done>
    WeekView and DayView time grids have correct ARIA grid semantics. Each time slot is a gridcell with aria-rowindex/aria-colindex and managed tabIndex via useRovingGrid. Arrow keys navigate between time slots. Only one slot has tabIndex={0} at any time.
  </done>
</task>

<task type="auto">
  <name>Task 2: ARIA grid for MonthView and managed tabIndex for EventBlock/MonthEventChip</name>
  <files>
    packages/core/src/views/month/MonthView.tsx
    packages/core/src/views/month/WeekRow.tsx
    packages/core/src/views/month/DayCell.tsx
    packages/core/src/components/EventBlock.tsx
  </files>
  <action>
**1. MonthView.tsx:**
- Import `useRovingGrid` from `../../hooks/use-roving-grid`
- Import `useCalendarStore` for `setFocusedDate`
- Add a `useRef<HTMLDivElement>(null)` for the MonthView container
- The month grid is naturally row-based: each `WeekRow` is a row, each `DayCell` is a cell. This is simpler than time-grid views.
- Call `useRovingGrid({ rows: weekStarts.length, cols: 7, gridRef, onCellFocus, onCellActivate })`
  - `onCellFocus`: Convert `(weekRowIndex, dayInWeekIndex)` to a Date using `addDays(weekStarts[row], col)`, then store via `setFocusedDate`
  - Compute `initialPosition` from `focusedDate` store value
- Wrap the week rows section in a container div with `ref={gridRef}`, `role="grid"`, `aria-label="Month view calendar grid"`, `aria-rowcount={weekStarts.length}`, `aria-colcount={7}`
- Pass `getCellProps` and `weekRowIndex` down to each `WeekRow`

**2. WeekRow.tsx:**
- Accept new props: `getCellProps` and `weekRowIndex: number`
- Add `role="row"` to the `.pro-calendr-react-month-dates-row` div (the row containing DayCell elements)
- Pass `getCellProps`, `weekRowIndex`, and `dayIndex` to each `DayCell`

**3. DayCell.tsx:**
- Accept new props: `getCellProps` (function), `rowIndex: number`, `colIndex: number`
- Spread `getCellProps(rowIndex, colIndex)` onto the `.pro-calendr-react-month-day-cell` div
- Add `role="gridcell"` to the day cell div
- Add `aria-label` with the full date: `format(date, 'EEEE, MMMM d, yyyy')`
- This gives each day cell: managed tabIndex, onKeyDown for arrow nav, onFocus, data-grid-row, data-grid-col

**4. EventBlock.tsx:**
- Change `tabIndex={0}` on line 89 to `tabIndex={-1}`. Events should NOT be independent tab stops when inside a roving tabindex grid. The grid cell is the tab stop; events within are activated via Enter/Space on the cell.
- Keep the existing `role="button"` and `onKeyDown` handler (Enter/Space activation) -- these still work when the event is focused programmatically or via screen reader.

**5. MonthEventChip (in WeekRow.tsx):**
- Change `tabIndex={0}` on the MonthEventChip div (line 146) to `tabIndex={-1}`. Same reasoning as EventBlock.
- Keep `role="button"` and existing Enter/Space `onKeyDown` handler.

**Why remove tabIndex={0}:** Research Pitfall 5 explicitly warns about this. If EventBlock and MonthEventChip keep tabIndex={0}, there will be multiple tab stops within the grid, violating the roving tabindex pattern. The grid cell owns the single tab stop. Events are activated via Enter/Space when their parent cell is focused.
  </action>
  <verify>
    Run `pnpm typecheck` -- no type errors.
    Run `pnpm lint` -- no lint violations.
    Verify MonthView has `role="grid"`, WeekRow dates row has `role="row"`, DayCell has `role="gridcell"`.
    Verify EventBlock has `tabIndex={-1}` (not `tabIndex={0}`).
    Verify MonthEventChip has `tabIndex={-1}`.
    Run `pnpm test:ci` -- existing tests pass. Note: Some EventBlock tests may check tabIndex={0} and need updating to tabIndex={-1}.
  </verify>
  <done>
    MonthView has complete ARIA grid semantics (grid > row > gridcell) with useRovingGrid providing keyboard navigation between day cells. EventBlock and MonthEventChip no longer have independent tabIndex={0} -- they are tabIndex={-1}, complying with roving tabindex. Arrow keys navigate month grid. Screen readers can announce grid position via aria-rowindex/aria-colindex on time-grid views and native DOM order on MonthView.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds
4. `pnpm test:ci` passes (update tests if they assert tabIndex={0} on EventBlock)
5. WeekView grid: `role="grid"` on container, `role="gridcell"` + `aria-rowindex`/`aria-colindex` on slots
6. DayView grid: Same ARIA attributes as WeekView with single column
7. MonthView: `role="grid"` on container, `role="row"` on week rows, `role="gridcell"` on day cells
8. Only one element with `tabIndex={0}` per grid at any time
9. EventBlock and MonthEventChip have `tabIndex={-1}`
</verification>

<success_criteria>
- All three views have correct ARIA grid semantics
- Arrow keys navigate between cells in each view via useRovingGrid
- Roving tabindex pattern enforced: exactly one tabIndex={0} per grid
- Events no longer pollute tab order with independent tabIndex={0}
- Existing tests still pass (with updated assertions where needed)
</success_criteria>

<output>
After completion, create `.planning/phases/04-keyboard-navigation-accessibility/04-02-SUMMARY.md`
</output>
