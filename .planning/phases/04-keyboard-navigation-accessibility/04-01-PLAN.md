---
phase: 04-keyboard-navigation-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/hooks/use-roving-grid.ts
  - packages/core/src/store/slices/interaction-slice.ts
  - packages/core/src/styles/calendar.css
autonomous: true

must_haves:
  truths:
    - "useRovingGrid hook returns getCellProps/getTabIndex/focusedCell for 2D grid navigation"
    - "Only one grid cell has tabIndex={0} at any given time (roving tabindex pattern)"
    - "Arrow keys move focus between cells, preventing default scroll"
    - "Home/End navigate to row start/end, Ctrl+Home/End to grid corners"
    - "focusedDate persists in Zustand store across view transitions"
    - "Focus indicators appear on keyboard focus (:focus-visible) with 2px outline"
  artifacts:
    - path: "packages/core/src/hooks/use-roving-grid.ts"
      provides: "2D roving tabindex hook for grid navigation"
      exports: ["useRovingGrid", "GridPosition"]
    - path: "packages/core/src/store/slices/interaction-slice.ts"
      provides: "focusedDate state for cross-view focus persistence"
      contains: "focusedDate"
    - path: "packages/core/src/styles/calendar.css"
      provides: "Focus indicator styles using :focus-visible"
      contains: "focus-visible"
  key_links:
    - from: "packages/core/src/hooks/use-roving-grid.ts"
      to: "packages/core/src/store/slices/interaction-slice.ts"
      via: "reads/writes focusedDate for cross-view persistence"
      pattern: "focusedDate"
---

<objective>
Create the useRovingGrid hook for 2D keyboard grid navigation, extend the interaction slice with focusedDate state, and add focus indicator CSS styles.

Purpose: This is the foundation for all keyboard navigation -- the hook manages which cell has tabIndex={0}, handles arrow key movement, and stores the focused date for persistence across view switches. Without this, no view can receive keyboard navigation.

Output: useRovingGrid hook, extended interaction slice, focus CSS styles.
</objective>

<execution_context>
@/home/blacksilver/.claude-personal/get-shit-done/workflows/execute-plan.md
@/home/blacksilver/.claude-personal/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-keyboard-navigation-accessibility/04-RESEARCH.md
@packages/core/src/store/slices/interaction-slice.ts
@packages/core/src/constants/keys.ts
@packages/core/src/styles/calendar.css
@packages/core/src/hooks/use-event-interactions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: useRovingGrid hook and interaction slice extension</name>
  <files>
    packages/core/src/hooks/use-roving-grid.ts
    packages/core/src/store/slices/interaction-slice.ts
    packages/core/src/store/calendar-store.ts
  </files>
  <action>
**1. Extend InteractionSlice** in `interaction-slice.ts`:
- Add `focusedDate: Date | null` field (default `null`)
- Add `setFocusedDate: (date: Date | null) => void` action
- This stores the logical date of the focused cell, surviving view transitions

**2. Create `use-roving-grid.ts`** with the following API:

```typescript
export interface GridPosition { row: number; col: number; }

export interface UseRovingGridOptions {
  rows: number;                    // Total rows (time slots for time-grid, weeks for month)
  cols: number;                    // Total cols (days in view)
  gridRef: RefObject<HTMLElement | null>;  // The grid container element
  onCellActivate?: (pos: GridPosition) => void;  // Called on Enter/Space
  onCellFocus?: (pos: GridPosition) => void;      // Called when focused cell changes
  disabled?: boolean;
  initialPosition?: GridPosition;  // Starting position (from focusedDate mapping)
}

export interface UseRovingGridReturn {
  focusedCell: GridPosition;
  setFocusedCell: (pos: GridPosition) => void;
  getTabIndex: (row: number, col: number) => 0 | -1;
  getCellProps: (row: number, col: number) => {
    tabIndex: 0 | -1;
    onKeyDown: (e: React.KeyboardEvent) => void;
    onFocus: () => void;
    'data-grid-row': number;
    'data-grid-col': number;
  };
}
```

**Implementation details:**
- Store `focusedCell` in a `useRef<GridPosition>` for immediate keyboard response (no re-render per arrow press). Use a `useState` counter (or `useReducer`) to force re-render only when the focused cell position changes so `getTabIndex` returns correct values.
- `handleKeyDown` reads from the existing `KEYS` constants for arrow key matching. Handle: ArrowUp, ArrowDown, ArrowLeft, ArrowRight, Home, End (with Ctrl modifier for grid corners).
- Call `e.preventDefault()` for handled arrow/Home/End keys to prevent page scroll.
- Do NOT handle Enter/Space/Escape here -- those are handled by the keyboard shortcuts hook (Plan 03). But DO call `onCellActivate` if Enter/Space is pressed (this lets views wire activation logic).
- After updating position, use `useEffect` that reads the ref and calls `gridRef.current.querySelector('[data-grid-row="R"][data-grid-col="C"]')?.focus()` to move DOM focus.
- Clamp position to valid bounds: `row` in `[0, rows-1]`, `col` in `[0, cols-1]`. No wrapping at edges (grid pattern, not menu pattern).
- Export `GridPosition` type for consumers.

**3. Update calendar-store.ts** if needed to include the new `focusedDate`/`setFocusedDate` from the interaction slice (should auto-compose if the slice pattern is correct).

**Key patterns to follow:**
- Use `KEYS` constants from `constants/keys.ts` for key matching (e.g., `KEYS.UP`, `KEYS.DOWN`)
- Follow the existing hook pattern: export a single `useRovingGrid` function
- Use `useRef` for row/col tracking (no store updates on every arrow press)
- The `onCellFocus` callback is where views will sync `focusedDate` to the store
  </action>
  <verify>
    Run `pnpm typecheck` -- no type errors.
    Run `pnpm lint` -- no lint violations.
    Verify InteractionSlice interface includes `focusedDate` and `setFocusedDate`.
    Verify `use-roving-grid.ts` exports `useRovingGrid` and `GridPosition`.
  </verify>
  <done>
    useRovingGrid hook exists with getCellProps/getTabIndex/focusedCell API. InteractionSlice has focusedDate/setFocusedDate. Arrow key navigation logic handles all four directions plus Home/End with clamping. Only one cell gets tabIndex={0} via getTabIndex.
  </done>
</task>

<task type="auto">
  <name>Task 2: Focus indicator CSS styles</name>
  <files>
    packages/core/src/styles/calendar.css
  </files>
  <action>
Add focus indicator styles to `calendar.css` using `:focus-visible` (WCAG 2.4.7). Place them after the existing structural styles, before the "Event Interactions" section.

**Add these rules:**

```css
/* === Keyboard Focus Indicators === */

/* Time slot cells - inset outline to stay within container */
.pro-calendr-react-time-slot:focus-visible {
  outline: 2px solid var(--cal-accent);
  outline-offset: -2px;
  z-index: 2;
  position: relative;
}

/* Month day cells */
.pro-calendr-react-month-day-cell:focus-visible {
  outline: 2px solid var(--cal-accent);
  outline-offset: -2px;
  z-index: 2;
}

/* Events within grid - use box-shadow for rounded corners */
.pro-calendr-react-event:focus-visible {
  box-shadow: var(--cal-focus-ring);
  outline: none;
}

/* Month event chips */
.pro-calendr-react-month-event:focus-visible {
  box-shadow: var(--cal-focus-ring);
  outline: none;
}

/* All-day events */
.pro-calendr-react-allday-event:focus-visible {
  box-shadow: var(--cal-focus-ring);
  outline: none;
}

/* Overflow indicator */
.pro-calendr-react-overflow:focus-visible {
  outline: 2px solid var(--cal-accent);
  outline-offset: 1px;
}
```

**Important:**
- Use `outline` (not `border`) so layout is not affected
- Use `outline-offset: -2px` on cells so the outline stays within the cell boundary
- Use `box-shadow: var(--cal-focus-ring)` on events which have `border-radius` (outline doesn't follow border-radius in all browsers)
- The `--cal-focus-ring` variable is already defined in the CSS custom properties section as `0 0 0 2px var(--cal-accent)`
- Add `position: relative` to time-slot focus state so `z-index: 2` works (time slots are not positioned by default)
  </action>
  <verify>
    Run `pnpm build` -- no CSS build errors.
    Grep for `:focus-visible` in calendar.css -- should find at least 5 rules.
  </verify>
  <done>
    Focus indicator CSS exists for time slots, month day cells, events, month event chips, all-day events, and overflow indicators. All use :focus-visible (keyboard-only), 2px outlines using --cal-accent color, and don't affect layout.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds
4. `use-roving-grid.ts` exports useRovingGrid hook with GridPosition type
5. InteractionSlice has focusedDate/setFocusedDate
6. calendar.css has :focus-visible rules for all focusable calendar elements
</verification>

<success_criteria>
- useRovingGrid hook is importable and provides getCellProps/getTabIndex for any 2D grid
- Interaction slice stores focusedDate for cross-view persistence
- Focus CSS renders 2px accent-colored indicators on :focus-visible for all focusable elements
- No regressions in existing tests or build
</success_criteria>

<output>
After completion, create `.planning/phases/04-keyboard-navigation-accessibility/04-01-SUMMARY.md`
</output>
